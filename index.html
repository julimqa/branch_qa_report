<!-- QA Report í˜ì´ì§€ì˜ HTML ë§¤í¬ë¡œì— ì¶”ê°€í•  ì½”ë“œ -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #007bff;">
    <h3 style="color: #007bff; margin-top: 0;">ğŸš€ QA Report ìë™ ìƒì„±ê¸°</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        AffectedVersionì„ ì…ë ¥í•˜ë©´ í…œí”Œë¦¿ ê¸°ë°˜ìœ¼ë¡œ ìƒˆë¡œìš´ QA Report í˜ì´ì§€ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
    </p>
    
    <!-- ì™¸ë¶€ ì›¹í˜ì´ì§€ë¥¼ iframeìœ¼ë¡œ ì„ë² ë“œ -->
    <iframe 
        src="YOUR_DEPLOYED_URL_HERE" 
        width="100%" 
        height="600" 
        style="border: 1px solid #ddd; border-radius: 8px; background: white;"
        frameborder="0">
    </iframe>
    
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin-top: 15px;">
        <h4 style="color: #856404; margin-top: 0;">â„¹ï¸ ì‚¬ìš© ì•ˆë‚´</h4>
        <ul style="margin: 0; color: #856404; font-size: 14px;">
            <li><strong>í…œí”Œë¦¿ ê¸°ë°˜:</strong> "Report Template - Branch" í˜ì´ì§€ë¥¼ ìë™ìœ¼ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤</li>
            <li><strong>ìë™ ì—…ë°ì´íŠ¸:</strong> ëª¨ë“  JQLì—ì„œ affectedVersionì´ ì…ë ¥í•œ ê°’ìœ¼ë¡œ êµì²´ë©ë‹ˆë‹¤</li>
            <li><strong>ìœ„ì¹˜:</strong> ìƒì„±ëœ í˜ì´ì§€ëŠ” í˜„ì¬ "QA Report" í˜ì´ì§€ì˜ í•˜ìœ„ í˜ì´ì§€ë¡œ ìƒì„±ë©ë‹ˆë‹¤</li>
            <li><strong>ê¶Œí•œ:</strong> Confluenceì— ë¡œê·¸ì¸ë˜ì–´ ìˆê³  NFTMetaverse ìŠ¤í˜ì´ìŠ¤ì— í˜ì´ì§€ ìƒì„± ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤</li>
        </ul>
    </div>
</div>

<!-- PostMessage í†µì‹ ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
// iframeì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì•˜ì„ ë•Œ ì²˜ë¦¬
window.addEventListener('message', function(event) {
    // ë³´ì•ˆì„ ìœ„í•´ origin í™•ì¸ (ì‹¤ì œ ë°°í¬ URLë¡œ ë³€ê²½í•˜ì„¸ìš”)
    if (event.origin !== 'YOUR_DEPLOYED_DOMAIN_HERE') {
        return;
    }
    
    if (event.data.type === 'CREATE_QA_REPORT') {
        const { affectedVersion, pageTitle } = event.data;
        
        // Confluence APIë¥¼ í†µí•´ í˜ì´ì§€ ìƒì„±
        createQAReportPage(affectedVersion, pageTitle)
            .then(result => {
                // ê²°ê³¼ë¥¼ iframeìœ¼ë¡œ ë‹¤ì‹œ ì „ì†¡
                event.source.postMessage({
                    type: 'PAGE_CREATED',
                    success: true,
                    pageUrl: result.pageUrl,
                    pageTitle: result.pageTitle
                }, event.origin);
            })
            .catch(error => {
                // ì˜¤ë¥˜ë¥¼ iframeìœ¼ë¡œ ì „ì†¡
                event.source.postMessage({
                    type: 'PAGE_CREATED',
                    success: false,
                    error: error.message
                }, event.origin);
            });
    }
});

async function createQAReportPage(affectedVersion, pageTitle) {
    const baseUrl = window.location.origin;
    
    try {
        // 1. í…œí”Œë¦¿ í˜ì´ì§€ ë‚´ìš© ê°€ì ¸ì˜¤ê¸°
        const templateResponse = await fetch(`${baseUrl}/wiki/rest/api/content/42008650?expand=body.storage`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Atlassian-Token': 'no-check'
            },
            credentials: 'include'
        });
        
        if (!templateResponse.ok) {
            throw new Error(`í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨: HTTP ${templateResponse.status}`);
        }
        
        const templateData = await templateResponse.json();
        let templateContent = templateData.body.storage.value;
        
        // 2. JQLì—ì„œ affectedVersion êµì²´
        templateContent = templateContent.replace(/ovdr-6116/g, affectedVersion);
        
        // 3. ìƒˆ í˜ì´ì§€ ìƒì„±
        const finalTitle = pageTitle || `${affectedVersion} Report`;
        const createResponse = await fetch(`${baseUrl}/wiki/rest/api/content`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Atlassian-Token': 'no-check'
            },
            credentials: 'include',
            body: JSON.stringify({
                type: 'page',
                title: finalTitle,
                space: { key: 'NFTMetaverse' },
                parent: { id: '29698636' }, // QA Report í˜ì´ì§€ ID
                body: {
                    storage: {
                        value: templateContent,
                        representation: 'storage'
                    }
                }
            })
        });
        
        if (!createResponse.ok) {
            const errorData = await createResponse.json();
            throw new Error(`í˜ì´ì§€ ìƒì„± ì‹¤íŒ¨: ${errorData.message || createResponse.statusText}`);
        }
        
        const newPageData = await createResponse.json();
        const pageUrl = `${baseUrl}/wiki${newPageData._links.webui}`;
        
        return {
            pageUrl: pageUrl,
            pageTitle: finalTitle
        };
        
    } catch (error) {
        throw error;
    }
}
</script>