<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QA 리포트 생성기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 미세한 로딩 애니메이션 */
    .spin { animation: spin 1s linear infinite }
    @keyframes spin { to { transform: rotate(360deg) } }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <main class="max-w-3xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-semibold tracking-tight">QA 리포트 생성기</h1>
      <p class="text-sm text-slate-500">더이상 JQL을 하나하나 고치지 맙시다.</p>
    </header>

    <!-- 알림 영역 -->
    <div id="notice" class="hidden mb-4 rounded-xl border border-amber-300 bg-amber-50 px-4 py-3 text-amber-800 text-sm">
      <strong class="font-medium">참고:</strong> 기본은 <em>숨김 iframe</em>으로 호출하여 JSON이 화면에 보이지 않습니다.
      CORS를 설정하셨다면 상단 코드의 <code>USE_FETCH = true</code>로 바꿔 fetch 모드로 상세 결과를 볼 수 있습니다.
    </div>

    <!-- 탭 -->
    <div class="mb-4 inline-flex rounded-lg border bg-white p-1">
      <button id="tab-branch" class="px-4 py-2 text-sm rounded-md bg-slate-900 text-white">Branch Report</button>
      <button id="tab-release" class="px-4 py-2 text-sm rounded-md text-slate-600 hover:text-slate-900">Release Report</button>
    </div>

    <!-- Branch Report 카드 -->
    <section id="card-branch" class="rounded-2xl bg-white shadow-sm border p-6 space-y-5">
      <div class="space-y-1">
        <h2 class="text-lg font-semibold">AffectedVersion 기반 Report</h2>
        <p class="text-sm text-slate-500">JQL의 날짜 범위와 <code>affectedVersion</code>을 치환합니다.</p>
      </div>

      <form id="form-branch" class="space-y-4" novalidate>
        <label class="block">
          <span class="text-sm font-medium">affectedVersion</span>
          <input id="input-affected" name="affectedVersion" type="text"
                 placeholder="예: 1.0 Alpha Release"
                 class="mt-1 w-full rounded-lg border px-3 py-2 outline-none focus:ring-2 focus:ring-slate-400" />
        </label>

        <div class="flex items-center gap-2">
          <button type="submit"
                  class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800 active:scale-[0.99]">
            <span class="spin hidden" id="spin-branch">⏳</span>
            <span>Run AffectedVersion Report</span>
          </button>
          <button type="button" id="preview-branch"
                  class="text-sm text-slate-600 hover:text-slate-900 underline underline-offset-4">
            변경 내용 미리보기
          </button>
        </div>
      </form>

      <div id="result-branch" class="hidden rounded-xl border bg-slate-50 p-4 text-sm space-y-2"></div>
    </section>

    <!-- Release Report 카드 -->
    <section id="card-release" class="hidden rounded-2xl bg-white shadow-sm border p-6 space-y-5">
      <div class="space-y-1">
        <h2 class="text-lg font-semibold">LinkedIssues 기반 Report</h2>
        <p class="text-sm text-slate-500">JQL의 날짜 범위와 <code>linkedIssues("…")</code>를 치환합니다.</p>
      </div>

      <form id="form-release" class="space-y-4" novalidate>
        <label class="block">
          <span class="text-sm font-medium">linked (Jira Key)</span>
          <input id="input-linked" name="linked" type="text"
                 placeholder="예: QA-4362"
                 class="mt-1 w-full rounded-lg border px-3 py-2 outline-none focus:ring-2 focus:ring-slate-400" />
        </label>

        <div class="flex items-center gap-2">
          <button type="submit"
                  class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white hover:bg-slate-800 active:scale-[0.99]">
            <span class="spin hidden" id="spin-release">⏳</span>
            <span>Run LinkedIssues Report</span>
          </button>
          <button type="button" id="preview-release"
                  class="text-sm text-slate-600 hover:text-slate-900 underline underline-offset-4">
            변경 내용 미리보기
          </button>
        </div>
      </form>

      <div id="result-release" class="hidden rounded-xl border bg-slate-50 p-4 text-sm space-y-2"></div>
    </section>

    <!-- 숨김 iframe: JSON 노출 없이 호출만 수행 -->
    <iframe id="sink" name="sink" class="hidden" referrerpolicy="no-referrer"></iframe>

    <!-- 하단 도움말 -->
    <footer class="mt-8 text-xs text-slate-500">
      <p>※ Confluence 새 페이지 링크는 응답 JSON의 <code>links.webui</code>로 만들 수 있습니다. 기본(iframe) 모드에선 보안을 위해 파싱하지 않습니다.
         필요하면 n8n 응답에 CORS를 추가하고 <code>USE_FETCH = true</code>로 바꿔 주세요. <span class="italic">(CORS 적용 방식은 환경에 따라 다를 수 있어 <b>확실하지 않음</b>)</span></p>
    </footer>
  </main>

  <script>
    // ====== 환경 설정 ======
    const BRANCH_URL  = "https://n8n.ovdr.io/webhook/confluence/copy-and-replace";
    const RELEASE_URL = "https://n8n.ovdr.io/webhook/confluence/copy-and-replace-release";

    // 기본은 숨김 iframe 방식(서버 CORS 설정 불필요)
    // CORS를 설정했다면 true로 바꿔 fetch 모드 사용 가능
    const USE_FETCH = false;

    // 선택(탭) 전환
    const tabBranch  = document.getElementById('tab-branch');
    const tabRelease = document.getElementById('tab-release');
    const cardBranch = document.getElementById('card-branch');
    const cardRelease= document.getElementById('card-release');
    const notice     = document.getElementById('notice');

    function setTab(which){ 
      const isBranch = which === 'branch';
      tabBranch.className  = "px-4 py-2 text-sm rounded-md " + (isBranch ? "bg-slate-900 text-white" : "text-slate-600 hover:text-slate-900");
      tabRelease.className = "px-4 py-2 text-sm rounded-md " + (!isBranch ? "bg-slate-900 text-white" : "text-slate-600 hover:text-slate-900");
      cardBranch.classList.toggle('hidden', !isBranch);
      cardRelease.classList.toggle('hidden', isBranch);
    }
    tabBranch.onclick  = ()=>setTab('branch');
    tabRelease.onclick = ()=>setTab('release');
    setTab('branch');
    notice.classList.toggle('hidden', USE_FETCH); // fetch 모드면 안내 숨김

    // ====== 공통 유틸 ======
    const fmt2 = n => String(n).padStart(2,'0');
    function kstDateParts(d=new Date()){
      // 클라이언트에서 KST로 보이는 목적용 계산 (서버 기준과 몇 초 차이는 있을 수 있어 "확실하지 않음")
      const s = new Date(d.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
      return {
        yyyy: s.getFullYear(),
        mm: fmt2(s.getMonth()+1),
        dd: fmt2(s.getDate()),
        HH: fmt2(s.getHours()),
        MM: fmt2(s.getMinutes()),
        SS: fmt2(s.getSeconds())
      };
    }
    function jqlDateKST(){
      const p = kstDateParts();
      return `${p.yyyy}/${p.mm}/${p.dd}`;
    }
    function titleStampKST(){
      const p = kstDateParts();
      return `${p.yyyy.toString().slice(-2)}/${p.mm}/${p.dd}${p.HH}:${p.MM}:${p.SS}`;
    }
    function el(id){ return document.getElementById(id); }
    function showResult(boxId, html){
      const box = el(boxId);
      box.innerHTML = html;
      box.classList.remove('hidden');
    }
    function hideResult(boxId){
      el(boxId).classList.add('hidden');
      el(boxId).innerHTML = "";
    }
    function busy(spinId, on){ el(spinId).classList.toggle('hidden', !on); }

    // ====== 미리보기(무엇이 바뀌는지) ======
    function previewBranch(avRaw){
      const date = jqlDateKST();
      const start = `${date} 00:00`;
      const end   = `${date} 23:59`;
      const av = (avRaw||"").trim();
      const title = titleStampKST() + (av ? ` - ${av}` : "");
      const avLine = av ? `<li>affectedVersion → <code>"${escapeHtml(av)}"</code> 로 강제 인용 처리</li>`
                        : `<li>affectedVersion 변경 없음</li>`;
      showResult("result-branch", `
        <div class="text-slate-700">
          <div class="font-medium mb-1">이번 실행으로 적용되는 변경</div>
          <ul class="list-disc pl-5 space-y-1">
            <li>created &gt;= '<code>${start}</code>'</li>
            <li>created &lt;= '<code>${end}</code>'</li>
            ${avLine}
            <li>페이지 제목 미리보기: <code>${title}</code> <span class="text-xs text-slate-500">(KST, 로컬 계산 · <b>확실하지 않음</b>)</span></li>
          </ul>
        </div>
      `);
    }
    function previewRelease(linkedRaw){
      const date = jqlDateKST();
      const start = `${date} 00:00`;
      const end   = `${date} 23:59`;
      const lk = (linkedRaw||"").trim();
      const title = titleStampKST() + (lk ? ` - ${lk}` : "");
      const lkLine = lk ? `<li>linkedIssues → <code>"${escapeHtml(lk)}"</code> 로 교정</li>`
                        : `<li>linkedIssues 변경 없음</li>`;
      showResult("result-release", `
        <div class="text-slate-700">
          <div class="font-medium mb-1">이번 실행으로 적용되는 변경</div>
          <ul class="list-disc pl-5 space-y-1">
            <li>created &gt;= '<code>${start}</code>'</li>
            <li>created &lt;= '<code>${end}</code>'</li>
            ${lkLine}
            <li>페이지 제목 미리보기: <code>${title}</code> <span class="text-xs text-slate-500">(KST, 로컬 계산 · <b>확실하지 않음</b>)</span></li>
          </ul>
        </div>
      `);
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ====== 실행 (iframe / fetch) ======
    async function runBranch(avRaw){
      const av = (avRaw||"").trim();
      const url = BRANCH_URL + (av ? `?affectedVersion=${encodeURIComponent(av)}` : "");
      if (USE_FETCH){
        return callWithFetch(url, "result-branch");
      } else {
        callWithIframe(url, "result-branch");
      }
    }
    async function runRelease(lkRaw){
      const lk = (lkRaw||"").trim();
      const url = RELEASE_URL + (lk ? `?linked=${encodeURIComponent(lk)}` : "");
      if (USE_FETCH){
        return callWithFetch(url, "result-release");
      } else {
        callWithIframe(url, "result-release");
      }
    }

    function callWithIframe(url, boxId){
      const iframe = el('sink');
      // onload: 호출 완료 신호 (응답 본문은 크로스도메인이라 읽지 않음)
      iframe.onload = ()=>{
        showResult(boxId, successBlock(`
          트리거가 전송되었습니다.<br/>
          Confluence에서 새 페이지를 확인하세요. (상위 페이지에서 최근 문서를 확인)
        `));
      };
      iframe.src = url + (url.includes('?') ? '&' : '?') + '_t=' + Date.now();
    }

    async function callWithFetch(url, boxId){
      try{
        const res = await fetch(url, { method: 'GET', credentials: 'omit' }); // CORS 허용 필요
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        // 응답 JSON이 Confluence 업데이트 결과(페이지/링크 등)를 포함한다고 가정(환경에 따라 <확실하지 않음>)
        const data = await res.json().catch(()=> ({}));
        showResult(boxId, renderSuccessFromJson(data));
      }catch(err){
        showResult(boxId, errorBlock(`
          호출 중 오류가 발생했습니다: <code>${escapeHtml(String(err.message||err))}</code><br/>
          fetch 모드는 CORS가 필요합니다. 기본(iframe) 모드를 사용하거나, n8n 응답에
          <code>Access-Control-Allow-Origin</code> 헤더를 추가하세요. <span class="italic">(환경별로 상이 · <b>확실하지 않음</b>)</span>
        `));
      }
    }

    function successBlock(inner){
      return `<div class="rounded-lg border border-emerald-300 bg-emerald-50 p-3 text-emerald-800 text-sm">
        <div class="font-medium mb-1">✅ 성공</div>
        <div>${inner}</div>
      </div>`;
    }
    function errorBlock(inner){
      return `<div class="rounded-lg border border-rose-300 bg-rose-50 p-3 text-rose-800 text-sm">
        <div class="font-medium mb-1">⚠️ 오류</div>
        <div>${inner}</div>
      </div>`;
    }
    function renderSuccessFromJson(data){
      // Confluence content 응답의 일반적인 필드: id, title, _links.webui 혹은 links.webui 등 (스키마는 인스턴스 설정에 따라 <확실하지 않음>)
      const id = data?.id || data?.body?.id || data?.result?.id;
      const title = data?.title || data?.body?.title || "(제목 알 수 없음)";
      const webui = (data?._links?.webui) || (data?.links?.webui) || "";
      const base = "https://overdare.atlassian.net/wiki"; // 인스턴스 호스트 (필요시 수정)
      const pageUrl = webui ? (base + webui) : "";
      const linkHtml = pageUrl ? `<a href="${pageUrl}" target="_blank" rel="noopener" class="underline">페이지 열기</a>` : "<em class='text-slate-500'>링크 알 수 없음</em>";
      return successBlock(`
        <div class="space-y-1">
          <div>제목: <code>${escapeHtml(title)}</code></div>
          <div>ID: <code>${escapeHtml(String(id||"알 수 없음"))}</code></div>
          <div>${linkHtml}</div>
        </div>
        <details class="mt-2">
          <summary class="cursor-pointer select-none text-slate-600">원시 JSON 보기</summary>
          <pre class="mt-2 overflow-auto rounded bg-white/60 p-3 text-xs border">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
        </details>
      `);
    }

    // ====== 이벤트 바인딩 ======
    el('preview-branch').onclick = ()=>{
      hideResult('result-branch');
      previewBranch(el('input-affected').value);
    };
    el('preview-release').onclick = ()=>{
      hideResult('result-release');
      previewRelease(el('input-linked').value);
    };

    el('form-branch').addEventListener('submit', (e)=>{
      e.preventDefault();
      hideResult('result-branch');
      previewBranch(el('input-affected').value);
      busy('spin-branch', true);
      Promise.resolve(runBranch(el('input-affected').value))
        .finally(()=> busy('spin-branch', false));
    });

    el('form-release').addEventListener('submit', (e)=>{
      e.preventDefault();
      hideResult('result-release');
      previewRelease(el('input-linked').value);
      busy('spin-release', true);
      Promise.resolve(runRelease(el('input-linked').value))
        .finally(()=> busy('spin-release', false));
    });
  </script>
</body>
</html>
