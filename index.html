<!-- QA Report 페이지의 HTML 매크로에 추가할 코드 -->
<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #007bff;">
    <h3 style="color: #007bff; margin-top: 0;">🚀 QA Report 자동 생성기</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">
        AffectedVersion을 입력하면 템플릿 기반으로 새로운 QA Report 페이지가 자동 생성됩니다.
    </p>
    
    <!-- 외부 웹페이지를 iframe으로 임베드 -->
    <iframe 
        src="YOUR_DEPLOYED_URL_HERE" 
        width="100%" 
        height="600" 
        style="border: 1px solid #ddd; border-radius: 8px; background: white;"
        frameborder="0">
    </iframe>
    
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px; padding: 15px; margin-top: 15px;">
        <h4 style="color: #856404; margin-top: 0;">ℹ️ 사용 안내</h4>
        <ul style="margin: 0; color: #856404; font-size: 14px;">
            <li><strong>템플릿 기반:</strong> "Report Template - Branch" 페이지를 자동으로 복사합니다</li>
            <li><strong>자동 업데이트:</strong> 모든 JQL에서 affectedVersion이 입력한 값으로 교체됩니다</li>
            <li><strong>위치:</strong> 생성된 페이지는 현재 "QA Report" 페이지의 하위 페이지로 생성됩니다</li>
            <li><strong>권한:</strong> Confluence에 로그인되어 있고 NFTMetaverse 스페이스에 페이지 생성 권한이 필요합니다</li>
        </ul>
    </div>
</div>

<!-- PostMessage 통신을 위한 스크립트 -->
<script>
// iframe에서 메시지를 받았을 때 처리
window.addEventListener('message', function(event) {
    // 보안을 위해 origin 확인 (실제 배포 URL로 변경하세요)
    if (event.origin !== 'YOUR_DEPLOYED_DOMAIN_HERE') {
        return;
    }
    
    if (event.data.type === 'CREATE_QA_REPORT') {
        const { affectedVersion, pageTitle } = event.data;
        
        // Confluence API를 통해 페이지 생성
        createQAReportPage(affectedVersion, pageTitle)
            .then(result => {
                // 결과를 iframe으로 다시 전송
                event.source.postMessage({
                    type: 'PAGE_CREATED',
                    success: true,
                    pageUrl: result.pageUrl,
                    pageTitle: result.pageTitle
                }, event.origin);
            })
            .catch(error => {
                // 오류를 iframe으로 전송
                event.source.postMessage({
                    type: 'PAGE_CREATED',
                    success: false,
                    error: error.message
                }, event.origin);
            });
    }
});

async function createQAReportPage(affectedVersion, pageTitle) {
    const baseUrl = window.location.origin;
    
    try {
        // 1. 템플릿 페이지 내용 가져오기
        const templateResponse = await fetch(`${baseUrl}/wiki/rest/api/content/42008650?expand=body.storage`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Atlassian-Token': 'no-check'
            },
            credentials: 'include'
        });
        
        if (!templateResponse.ok) {
            throw new Error(`템플릿 로드 실패: HTTP ${templateResponse.status}`);
        }
        
        const templateData = await templateResponse.json();
        let templateContent = templateData.body.storage.value;
        
        // 2. JQL에서 affectedVersion 교체
        templateContent = templateContent.replace(/ovdr-6116/g, affectedVersion);
        
        // 3. 새 페이지 생성
        const finalTitle = pageTitle || `${affectedVersion} Report`;
        const createResponse = await fetch(`${baseUrl}/wiki/rest/api/content`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Atlassian-Token': 'no-check'
            },
            credentials: 'include',
            body: JSON.stringify({
                type: 'page',
                title: finalTitle,
                space: { key: 'NFTMetaverse' },
                parent: { id: '29698636' }, // QA Report 페이지 ID
                body: {
                    storage: {
                        value: templateContent,
                        representation: 'storage'
                    }
                }
            })
        });
        
        if (!createResponse.ok) {
            const errorData = await createResponse.json();
            throw new Error(`페이지 생성 실패: ${errorData.message || createResponse.statusText}`);
        }
        
        const newPageData = await createResponse.json();
        const pageUrl = `${baseUrl}/wiki${newPageData._links.webui}`;
        
        return {
            pageUrl: pageUrl,
            pageTitle: finalTitle
        };
        
    } catch (error) {
        throw error;
    }
}
</script>